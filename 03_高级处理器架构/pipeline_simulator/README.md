# 流水线CPU模拟器

这个模拟器展示了流水线CPU的工作原理，包括流水线各个阶段的执行过程和冒险处理机制。

## 功能特点

- 可视化流水线各个阶段的执行
- 模拟数据冒险、控制冒险和结构冒险
- 实现前递、停顿和分支预测等技术
- 提供流水线性能分析
- 支持自定义指令序列

## 文件说明

- `pipeline.py`: 流水线核心实现
- `hazard_detection.py`: 冒险检测和处理
- `forwarding.py`: 数据前递实现
- `branch_prediction.py`: 分支预测实现
- `pipeline_registers.py`: 流水线寄存器实现
- `simulator.py`: 模拟器主程序
- `visualizer.py`: 流水线可视化
- `examples/`: 示例程序

## 使用方法

1. 运行模拟器：

```bash
python simulator.py [程序文件] [--options]
```

可选参数：
- `--forwarding`: 启用数据前递
- `--branch-prediction`: 启用分支预测
- `--prediction-type {static,dynamic}`: 选择分支预测类型

2. 交互式命令：

- `step`: 单步执行一个时钟周期
- `run [n]`: 连续执行n个周期
- `show`: 显示当前流水线状态
- `hazards`: 显示检测到的冒险
- `performance`: 显示性能统计
- `help`: 显示帮助信息
- `quit`: 退出模拟器

## 流水线阶段

标准五级流水线包含以下阶段：

1. **取指令(IF)**: 从内存读取指令
2. **解码(ID)**: 解析指令，读取寄存器
3. **执行(EX)**: 执行ALU操作
4. **访存(MEM)**: 读写内存
5. **写回(WB)**: 将结果写回寄存器

## 流水线冒险

### 数据冒险

当指令依赖于前面指令的结果时发生数据冒险。模拟器实现了以下处理方法：

- **数据前递(Forwarding)**: 将结果直接从一个流水线阶段传递到另一个阶段
- **流水线停顿(Stalling)**: 暂停流水线直到数据可用

### 控制冒险

当分支指令改变程序流时发生控制冒险。模拟器实现了以下处理方法：

- **分支预测(Branch Prediction)**: 预测分支结果并投机执行
- **延迟槽(Delay Slots)**: 在分支指令后执行一条指令，无论分支结果如何
- **分支目标缓冲(BTB)**: 缓存分支目标地址

### 结构冒险

当多条指令同时需要访问同一硬件资源时发生结构冒险。模拟器实现了以下处理方法：

- **流水线停顿**: 暂停流水线直到资源可用
- **资源复制**: 提供多个功能单元

## 性能分析

模拟器提供以下性能指标：

- **CPI (Cycles Per Instruction)**: 每条指令的平均周期数
- **吞吐量(Throughput)**: 单位时间内完成的指令数
- **流水线效率(Pipeline Efficiency)**: 流水线的利用率
- **停顿统计(Stall Statistics)**: 各类停顿的数量和原因
- **分支预测准确率(Branch Prediction Accuracy)**: 分支预测的成功率

## 学习要点

通过这个模拟器，你可以学习：

1. 流水线CPU的基本工作原理
2. 流水线冒险的类型和处理方法
3. 数据前递和分支预测的实现
4. 流水线性能分析和优化
5. 流水线控制逻辑的设计

## 扩展思路

1. 实现超标量流水线
2. 添加乱序执行支持
3. 实现更复杂的分支预测算法
4. 添加缓存层次结构
5. 实现精确异常处理 